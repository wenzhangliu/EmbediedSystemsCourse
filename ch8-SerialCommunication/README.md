# 串行通信

```
作者：柳文章
日期：2025.4.11
```

## 基本概念

- **串行通信**：Serial communication，是指在计算机总线或其他数据通道上，每次传输一个位元数据，并连续进行以上单次过程的通信方式。串行通信可被用于长距离通信和大多数计算网络。
  - 异步串行通信：接收器和发送器有各自的时钟，非同步工作。一般由1个起始位、7-9个数据位、1-2个停止位、1个校验位组成。起始位约定为0，空闲位约定为1。
  - 同步串行通信：接收器和发送器由同一个时钟源控制。
- **并行通信**：Parallel communication，是指在串行端口上通过一次同时传输若干位元数据的方式进行通信。
- **波特率（BR）**：单位时间传输的数据位数，单位: bps (bit per second)。
- **串行通信的校验**：异步通信时可能出现帧格式错误、超时错误等传输错误。因此，一般考虑在通信过程中对数据差错进行校验，保证传输无误。
- **传输方式**：
  - 单工：消息只能单向传播，如遥控器；
  - 半双工：数据可以在一个信号载体的两个方向传播，但是不能同时进行，如对讲机。
  - 全双工：允许数据在两个方向上同时传播，相当于两个单工通信的结合。

## 通用同步异步收发器（USART）

USART 全称为“universal synchronous and asynchronous receiver-transmitter”。

### USART概述

两个引脚：
- RX：接受数据串行输入。
- TX：发送数据输出。当发送器被禁止时，输出引脚恢复到它的I/O端口配置。当发送器被激活，并且不发送数据时，TX引脚处于高电平状态。
- 总线在发送或接收前应处于空闲状态。
- 一个起始位。
- 一个数据字（8或9位），最低有效位在前。
- 0.5、1.5、2个的停止位，由此表明帧的结束。
- 使用分数波特率发生器——12位整数和4位小数的表示方法。
- 一个状态寄存器（USART_SR）。
- 数据寄存器（USART_DR）。
- 一个波特率寄存器（USART_BRR），12位的整数和4位小数。
- 一个智能卡模式下的保护时间寄存器（USART_GTPR）。

#### I/O口说明

STM32F103芯片有三组USART模块：USART1、USART2、USART3。

USART I/O口说明表如下：

| 端口     | 引脚         | I/O口 | 重映射口 | 功能说明         |
|--------|------------|------|------|--------------|
| USART1 | USART1_TX  | PA9  | PB6  | 发送数据输出       |
|        | USART1_RX  | PA10 | PB7  | 接收数据输入       |
|        | USART1_CTS | PA11 |      | 清除发送         |
|        | USART1_RTS | PA12 |      | 发送请求         |
|        | USART1_CK  | PA8  |      | 同步模式时，作为同步时钟 |
| USART2 | USART2_TX  | PA2  | PD7  | 发送数据输出       |
|        | USART2_RX  | PA3  | PD6  | 接收数据输入       |
|        | USART2_CTS | PA0  | PD3  | 清除发送         |
|        | USART2_RTS | PA1  | PD4  | 发送请求         |
|        | USART2_CK  | PA4  | PD7  | 同步模式时，作为同步时钟 |
| USART3 | USART3_TX  | PB10 | PD8  | 发送数据输出       |
|        | USART3_RX  | PB11 | PD9  | 接收数据输入       |
|        | USART3_CTS | PB13 | PD11 | 清除发送         |
|        | USART3_RTS | PB14 | PD12 | 发送请求         |
|        | USART3_CK  | PB12 | PD10 | 同步模式时，作为同步时钟 |

#### 时钟管理

为了使能USART模块的工作时钟，需要使能串口以及对应的引脚时钟，以USART1异步基本串行通信模式为例，时钟配置如下：

```c
RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1 | RCC_APB2Periph_GPIOA | RCC_APB2Periph_AFIO, ENABLE)
```

#### 中断源

USART模块对应的中断函数：
- ``void USART1_IRQHandler(void)``;
- ``void USART2_IRQHandler(void)``;
- ``void USART3_IRQHandler(void)``.
这些函数名称不能改变，已经在启动文件中做了指定。

有关USART的中断号需要在NVIC中断配置函数中指定，在``stm32f10x.h``头文件中，被设置为：``USART1_IRQn``, ``USART2_IRQn``, ``USART3_IRQn``。这些名称不能改变。

### USART帧格式

起始位 + 数据帧 + 可能的奇偶校验位

USART支持多种停止位的配置：
- 1个停止位：停止位位数的默认值；
- 2个停止位：可用于常规USART模式、单线模式以及调制解调器模式；
- 0.5个停止位：在智能卡模式下接收数据时使用；
- 1.5个停止位：在智能卡模式下发送和接收数据时使用。

### USART寄存器

### USART库函数

库函数列表：

| 函数名                 | 描述                 |
|---------------------|--------------------|
| USART_Init          | 初始化所使用的串口外设        |
| USART_ITConfig      | 使能或者失能指定的USART中断   |
| USART_SendData      | 通过外设USARTx发送单个数据   |
| USART_ReceiveData   | 返回USARTx最近解释接收到的数据 |
| USART_GetFlagStatus | 检查指定的USART标志位设置与否  |
| USART_ClearFlag     | 清除USARTx的待处理标志位    |
| USART_GetITStatus   | 检查指定的USART中断发生与否   |

初始化示例：
```c
USART_InitTypeDef usart_init = {
.USART_BaudRate = 9600,  // 波特率
.USART_WordLength = USART_WorldLength_8b,  //数据位8位
.USART_StopBits = USART_StopBits_1,  //1位停止位
.USART_Parity = USART_Parity_No,  //无奇偶校验
.USART_HardwareFlowControl = USART_HardwareFlowControl_None,  //无硬件流
.USART_Mode = USART_Mode_Rx | USART_Mode_Tx,  //发送接收模式
};
.USART_Init(USART1, &usart_init);
.USART_Cmd(USART1, ENABLE);
```

## USART操作

### USART发送与接收

STM32通过三个引脚建立通信：RX、TX、GND。

USART串口通信模块一般分为三大部分：
- 时钟发生器；
- 数据发送器；
- 数据接收器。

#### 数据发送器

- 当内核或DMA外设把数据写入发送数据寄存器（TDR）后，发送控制器自动地把数据加载到发送移位寄存器中，通过串口线TX把数据逐位送出去。
- 当数据从TDR转移到移位寄存器时，会产生发送寄存器TDR已空时间TXE。
- 当数据从移位寄存器全部发送出去时，会产生数据发送完成事件TC，这些事件可以在状态寄存器中查询得到。

发送一个字节函数：
```c
void usart_send_byte(unsigned char data)
{
  USART_SendData(USART1, data);
  while(!USART_GetFlagStatus(USART1, USART_FLAG_TC));  //等待数据发送完成
}
```

#### 数据接收器

- 接收数据是从串口线RX逐位输入到接收移位寄存器中；
- 然后自动地转移到接收数据寄存器RDR；
- 并会产生接收数据事件RXNE，表示数据已接收到。
- 在查询到RXNE位置1后，把数据读取到内存中。

接收一个字节函数：
```c
unsigned char usart_recv_byte(void)
{
  while(!USART_GetFlagStatus(USART, USART_FLAG_RXNE));  //查询是否接收到数据
  return USART_ReceiveData(USART1);
}
```

#### 波特率设置

- 波特率：每秒传送二进制位数。
- 单位：Bit/s。

波特率是串行通信的重要指标，表示数据传输的速度。通过USART_BRR寄存器来设置，包括12位整数部分和4位小数部分。

注意：接收器和发送器的波特率在USARTDIV的整数和小数寄存器中的值要设置为相同。

波特率计算公式：

$$\text{波特率}=\frac{f_{CK}}{16 \times USARTDIV}$$

其中：
- $f_{CK}$：外设时钟；
- USARTDIV分为整数部分和小数部分：
  - 整数部分：DIV_Mantissa（12位）
  - 小数部分：DIV_Fraction（4位）

例：
USARTDIV=25.62：
- 整数部分为25，即0x19，
- 小数部分为0.62，16*0.62=9.92，最接近的整数为10，即0x0A，
- 合在一起：USART_BRR=0x19A

### 硬件流控制

硬件流控制用于解决两台机器之间传输数据的速度匹配问题。
即使波特率设置为一样，但是仍有可能存在数据丢失、数据缓冲区已满但是仍有数据发送过来的情况。

硬件流控制的原理，是当接收端接收到的数据处理不过来时，就向发送端发送不再接收的信号，
发送端接收到这个信号之后就会停止发送，直到收到可以继续发送的信号再继续发送。
因此流控本身是可以控制数据传输的进度，进而防止数据丢失。

- RTS流控制：只要USART接收器准备好接收新数据，nRTS变为有效（接低电平）。当寄存器内有数据达到，nRTS被释放。在当前帧结束时停止传输。
- CTS流控制：发送器在发送下一帧前检查nCTS输入。当nCTS有效（被拉成低电平），则下一个数据被发送。

### 奇偶校验

设置USART_CR1上的PCE位，使能奇偶控制，即发送时生成一个奇偶位，接收时进行奇偶校验。

M位和PCE位决定的USART帧格式：

| M位 | PCE位 | USART帧                             |
|----|------|------------------------------------|
| 0  | 0    | \| 起始位 \| 8位数据位 \| 停止位 \|          |
| 0  | 1    | \| 起始位 \| 7位数据位 \| 奇偶校验位 \| 停止位 \| |
| 1  | 0    | \| 起始位 \| 9位数据位 \| 停止位 \|          |
| 1  | 1    | \| 起始位 \| 8位数据位 \| 奇偶校验位 \| 停止位 \| |

- 偶校验：校验位使得一帧中的7或8个LSB数据以及校验位中"1"的个数位偶数。例如，数据"00110101"有4个"1"，若选择偶校验（USART_CR1中的PS=0），校验位将是"0"；
- 奇校验：校验位使得一帧中的7或8个LSB数据以及校验位中"1"的个数位奇数。例如，数据"00110101"有4个"1"，若选择奇校验（USART_CR1中的PS=1），校验位将是"1"。

### USART中断请求

| 中断事件                 | 事件标志      | 使能位    |
|----------------------|-----------|--------|
| 发送数据寄存器空             | TXE       | TXEIE  |
| CTS标志                | CTS       | CTSIE  |
| 发送完成                 | TC        | TCIE   |
| 接收数据就绪可读             | TXNE      | TXNEIE |
| 检测到数据溢出              | ORE       | TXNEIE |
| 检测到空闲线路              | IDLE      | IDLEIE |
| 奇偶校验错                | PE        | PEIE   |
| 断开标志                 | LBD       | LBDIE  |
| 噪声标志，多缓冲通信中的溢出错误和帧错误 | NE或ORT或FE | EIE    |

## STM32芯片USART其他功能模式及扩展说明

### USART其他功能模式

- 多处理器通信：将几个USART连在一个网络里。
- LIN（局域互联网）模式：为汽车网络开发的一种低成本、低端多路复用通信标准。
- USART同步模式：允许用户以主模式方式控制双向同步串行通信。
- 单线半双工通信：设置USART_CR3寄存器的HDSEL位选择单线半双工模式。
- 智能卡模式：与ISO7816兼容的模式。允许与智能卡连接，并可通过ISO7816链接与安全访问模块（SAM）通信。
- IrDA SIR ENDEC功能模块：IrDA是一个半双工通信协议。

### RS-232接口

个人计算机上的通信接口之一，是电子工业协会（EIA）制定的异步传输标准接口。

RS-232与TTL转换：RS232是用正负电压来表示逻辑状态，与TTL以高电平表示逻辑状态的规定不同。
因此，为了能够同计算机接口或终端的TTL器件连接，必须在RS232与TTL电路之间进行电平和逻辑关系的变换。

MAX232芯片是广泛使用的RS232和TTL之间的转换器件。

### 基于串口的无线通信

- 蓝牙串口：SPP协议，能在蓝牙设备之间创建串口进行数据传输。
- 串口无线网络（WiFi）：串口转WiFi模块。
- ZigBee通信：一种短距离、低数据速率、低功耗、低成本的双向无线通信技术。
- GPRS通信：支持GPRS和短消息双通道传输数据，GPRS模块能够将串口通信转为GPRS无线通信。利用运营商GPRS网络（G网）为用户提供无线长距离数据传输功能。

## USART应用实例

### 查询传送方式

案例：通过串口助手利用串口从电脑端发送数据给STM32，STM32接收到数据后再把数据送回电脑。（采用查询方式实现）

### 中断传送方式

案例：同上，但是通过中断方式实现。

### 环形队列串口应用

查询传送方式的程序效率非常低下；中断传送方式在数据量较大的时候会导致丢包（频繁响应中断）。

因此，可以将接收缓冲区建立成一个环形的缓冲区，通过头指针（HostIndex）和尾指针（TailIndex）来定位空白区和数据区。

- 头指针：指向数据区顶部，每次写入数据都更新头指针。
- 尾指针：指向数据区的尾部，当数据传送出去后更新尾指针位置。

案例：同上，但是通过环形队列方式实现。
